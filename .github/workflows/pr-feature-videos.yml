name: PR Feature Videos

on:
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  validate-selector-block:
    runs-on: ubuntu-latest
    steps:
      - name: Validate video selector block in PR body
        uses: actions/github-script@v7
        with:
          script: |
            const startMarker = '<!-- video-tests:start -->';
            const endMarker = '<!-- video-tests:end -->';
            const body = context.payload.pull_request?.body ?? '';

            const hasStart = body.includes(startMarker);
            const hasEnd = body.includes(endMarker);

            if (!hasStart || !hasEnd) {
              core.setFailed(
                'PR body must include exactly one video selector block delimited by `<!-- video-tests:start -->` and `<!-- video-tests:end -->`.'
              );
              return;
            }

            const startIndex = body.indexOf(startMarker);
            const endIndex = body.indexOf(endMarker, startIndex + startMarker.length);
            if (endIndex === -1 || endIndex < startIndex) {
              core.setFailed('PR body video selector block is malformed: end marker must appear after start marker.');
              return;
            }

            const secondStartIndex = body.indexOf(startMarker, startIndex + startMarker.length);
            const secondEndIndex = body.indexOf(endMarker, endIndex + endMarker.length);
            if (secondStartIndex !== -1 || secondEndIndex !== -1) {
              core.setFailed('PR body must include exactly one video selector block.');
            }

  feature-videos:
    needs: validate-selector-block
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Resolve video test selectors
        id: selectors
        uses: actions/github-script@v7
        with:
          script: |
            const startMarker = '<!-- video-tests:start -->';
            const endMarker = '<!-- video-tests:end -->';
            const body = context.payload.pull_request?.body ?? '';

            function normalizeSelectors(rawSelectors) {
              const deduped = new Set();

              for (const entry of rawSelectors) {
                const selector = entry.replace(/#.*$/, '').trim();
                if (selector.length === 0) {
                  continue;
                }
                deduped.add(selector);
              }

              return Array.from(deduped);
            }

            const startIndex = body.indexOf(startMarker);
            const endIndex = startIndex === -1 ? -1 : body.indexOf(endMarker, startIndex + startMarker.length);
            const hasSelectorBlock = startIndex !== -1 && endIndex !== -1;

            let selectors = [];
            let selectorSource = 'none';

            if (hasSelectorBlock) {
              const markerContent = body.slice(startIndex + startMarker.length, endIndex);
              selectors = normalizeSelectors(markerContent.split(/\r?\n/));
              selectorSource = selectors.length > 0 ? 'pr-body-markers' : 'pr-body-markers-empty';
            }

            core.setOutput('enabled', selectors.length > 0 ? 'true' : 'false');
            core.setOutput('selector_block', selectors.join('\n'));
            core.setOutput('selector_source', selectorSource);

      - name: Install dependencies
        if: steps.selectors.outputs.enabled == 'true'
        run: npm ci

      - name: Install Playwright Chromium
        if: steps.selectors.outputs.enabled == 'true'
        run: npx playwright install --with-deps chromium

      - name: Run selected E2E tests with video recording
        if: steps.selectors.outputs.enabled == 'true'
        env:
          PLAYWRIGHT_CAPTURE_VIDEO: '1'
          GAME_SPACE_ADMIN_PASSWORD_HASH: 'scrypt$ASNFZ4mrze8BI0VniavN7w==$M+OVA7qtmUR3CHE87sPzm7h2MpJU1PXNk9qSpl2YPwHyaL8eByBbvuCTXEVTUVc/mwL9EhXgQ14qdOIyRUXu1Q=='
          GAME_SPACE_ADMIN_SESSION_SECRET: 'ci-feature-video-session-secret-value-32'
          SELECTOR_BLOCK: ${{ steps.selectors.outputs.selector_block }}
        run: |
          set -euo pipefail
          while IFS= read -r selector; do
            if [ -n "$selector" ]; then
              echo "Running selector: $selector"
              npx playwright test "$selector"
            fi
          done <<< "$SELECTOR_BLOCK"

      - name: Upload Playwright artifacts
        if: always() && steps.selectors.outputs.enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: feature-videos-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          if-no-files-found: warn

      - name: Upsert PR feature video comment
        if: always()
        uses: actions/github-script@v7
        env:
          VIDEO_ENABLED: ${{ steps.selectors.outputs.enabled }}
          SELECTOR_BLOCK: ${{ steps.selectors.outputs.selector_block }}
          SELECTOR_SOURCE: ${{ steps.selectors.outputs.selector_source }}
        with:
          script: |
            const marker = '<!-- feature-video-comment -->';
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100
            });

            const existing = comments.find((comment) =>
              comment.user?.type === 'Bot' && typeof comment.body === 'string' && comment.body.includes(marker)
            );

            const enabled = process.env.VIDEO_ENABLED === 'true';
            const selectorsRaw = (process.env.SELECTOR_BLOCK || '').trim();
            const selectorsText = selectorsRaw.length > 0 ? selectorsRaw.split('\n').map((v) => `- \`${v}\``).join('\n') : '- _none_';
            const selectorSource = process.env.SELECTOR_SOURCE || 'none';
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const selectorSourceText = selectorSource === 'pr-body-markers'
              ? 'from the PR body `video-tests` marker block.'
              : selectorSource === 'pr-body-markers-empty'
                ? 'from the PR body marker block, but the block was empty.'
                : 'from this PR update metadata.';

            const body = enabled
              ? [
                  marker,
                  '## Feature Video Artifacts',
                  'Videos were generated for selected Playwright tests.',
                  '',
                  `Selectors were resolved ${selectorSourceText}`,
                  '',
                  '**Selected tests**',
                  selectorsText,
                  '',
                  '**Artifacts**',
                  `- [Open workflow run](${runUrl})`,
                  `- Download artifact: \`feature-videos-${context.runId}\``
                ].join('\n')
              : [
                  marker,
                  '## Feature Video Artifacts',
                  'No selectors were resolved, so video recording was skipped.',
                  '',
                  'Provide selectors between:',
                  '- `<!-- video-tests:start -->`',
                  '- `<!-- video-tests:end -->`',
                  'in the PR body.'
                ].join('\n');

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }
